# 风风博客博客开发小记（番外）：一只搜索栏引发的“离谱”大冒险

> 这是一篇轻松又真实的前端调试故事，  
> 讲述了一个小小的搜索栏，如何像蝴蝶扇动翅膀一样，  
> 让整个博客页面陷入“空白风暴”——以及我们是怎么抓住这只“蝴蝶”的！

---

## 1. 故事的开头：动画加持下的“神秘空白”

事情的起因很简单：我们想让博客切换页面时更酷一点，于是加上了 Vue 的 `<transition>` 动画。  
本来以为只是加点特效，没想到“画廊”和“友情链接”这两个页面突然变得“有毒”了！

- **现象一**：只要切到这两个页面的任意一个，内容区就大概率会变成一片空白，啥都没了qwq。
- **现象二**：一旦变空白，怎么切换都回不来了，即使是切换到其他页面QAQ。
- **现象三**：控制台没有任何报错，DOM元素里只剩下一个孤零零的

```html
<div class="content-view glass-container"><!---->::after</div>
```

---

## 2. 排查大冒险：动画、路由、数据，谁才是真凶？

### 2.1 怀疑动画和路由

我们首先怀疑是不是 `<transition>` 和 `<router-view>` 的用法不对。  
试了官方推荐的写法，调整了 key，甚至把动画钩子全都注释掉，  
结果问题依然坚如磐石。

### 2.2 检查路由和数据加载

接着检查路由配置、嵌套路由、路由守卫，  
确保每个页面都能被正确加载，数据也都提前准备好。  
依然一切正常，问题依旧。

### 2.3 怀疑组件本身

我们又怀疑是不是页面组件 setup 阶段出错，  
加了 `onErrorCaptured` 钩子，结果还是没有任何异常被捕获。

---

## 3. 真相揭晓：搜索栏的“蝴蝶效应”

就在我们快要放弃的时候，终于发现了“有毒页面”的共同点：  
**它们都用到了本地搜索和排序的组合式函数 `useSearchAndSort`。**

#### 3.1 关键代码片段

```ts
const artworks = computed(() => artworkStore.artworks)
const {
  searchText,
  filteredItems: filteredArtworks,
  sortButton,
} = useSearchAndSort({
  items: artworks.value, // ❌ 只拿了一次初始值，后面就不管了
  ...
})
```

#### 3.2 问题的本质

- **错误用法**：我们把 `artworks.value`（普通数组）传进去了，而不是 `artworks`（响应式的 computed）。
- **后果**：`useSearchAndSort` 只拿到页面刚加载时的数据，后面即使数据变了，页面也不会自动刷新，filteredArtworks 也不会更新。
- **极端情况下**：动画切换时，组件渲染时拿到的是空数组，transition 直接把内容区卸载，页面就永远空白了。

#### 3.3 “蝴蝶效应”有多可怕？

一个小小的 `.value`，让搜索栏变成了“全站杀手”——  
它让响应式链条断了，最终导致页面彻底空白，连报错都没有！

---

## 4. 解决办法：让响应式“活”起来

### 4.1 正确的打开方式

```ts
const artworks = computed(() => artworkStore.artworks)
const {
  searchText,
  filteredItems: filteredArtworks,
  sortButton,
} = useSearchAndSort({
  items: artworks, // ✅ 直接传 computed，响应式链条就不会断
  ...
})
```

### 4.2 组合式函数也要“聪明”一点

在 `useSearchAndSort` 里，参数类型要写成 `T[] | Ref<T[]> | ComputedRef<T[]>`，  
并用 `unref` 统一处理，这样不管传什么都能自动响应。

---

## 5. 小结与反思

### 5.1 响应式的“坑”

- Vue 3 的响应式很强大，但一旦 `.value` 用错地方，响应链就会悄悄断掉。
- 组合式函数的参数要支持响应式对象，内部用 `unref` 处理最保险。

### 5.2 动画和动态组件的“放大镜”

- `<transition>` + `<router-view>` 会把响应式链断裂的后果无限放大。
- 动画切换时，组件卸载/挂载的时机很敏感，数据没到位时就容易出大问题。

### 5.3 调试小贴士

- 遇到页面空白但没报错，优先排查响应式数据链是不是断了。
- 组合式函数参数尽量传响应式对象，不要提前 `.value`。
- 多用 `onErrorCaptured`、`console.log` 等手段辅助定位。

---

## 6. 彩蛋结语

这次“离谱”的调试经历告诉我们：  
**前端开发，细节决定命运！**  
一个小小的 `.value`，就能让整个博客“消失”。  
希望这篇故事能帮你在响应式开发和组合式函数设计上少踩坑，多一点好运气！

---

> 被.value干爆的风酱 著
